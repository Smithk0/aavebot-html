<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AAVE TOKEN WEB APP</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>AAVE TOKEN</h1>
        </div>
        
        <div class="tabs">
            <button class="tab-button" data-tab="wallet">Wallet</button>
            <button class="tab-button" data-tab="earn">Earn</button>
            <button class="tab-button" data-tab="connect">Connect</button>
        </div>
        
        <div id="wallet" class="tab-content active">
            <div class="balance-container">
                <p id="wallet-balance">0 $AAVE</p>
                <p>Current Balance</p>
            </div>
        </div>
        
        <div id="earn" class="tab-content">
            <button id="generate-referral-link-btn">Generate Referral Link</button>
            <div id="referred-users">
                <h3>Referred Users</h3>
                <ul id="referred-users-list"></ul>
            </div>
        </div>
        
        <div id="connect" class="tab-content">
            <h3>Connect</h3>
            <button id="connect-ton-btn">Connect TON</button>
            <button id="connect-eth-btn">Connect ETH</button>
            <button id="connect-tron-btn">Connect TRON</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;

        console.log("Telegram WebApp initialized:", tg);

        // Tab functionality
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tab = button.getAttribute('data-tab');
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.toggle('active', content.id === tab);
                });
            });
        });

        // Generate Referral Link
        document.getElementById('generate-referral-link-btn').addEventListener('click', async () => {
            console.log("Generate Referral Link button clicked");
            try {
                const response = await fetch('/generate_referral', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: tg.initDataUnsafe.user.id,
                        username: tg.initDataUnsafe.user.username
                    }),
                });
                const data = await response.json();
                if (data.referral_link) {
                    navigator.clipboard.writeText(data.referral_link).then(() => {
                        alert("Referral link copied to clipboard!");
                    }).catch(err => {
                        console.error("Failed to copy referral link: ", err);
                    });

                    // Update referred users list
                    const referredUsers = ["user1", "user2", "user3"]; // Replace with actual referred users list
                    const referredUsersList = document.getElementById('referred-users-list');
                    referredUsersList.innerHTML = referredUsers.map(user => `<li>${user}</li>`).join('');
                }
            } catch (error) {
                console.error("Error generating referral link:", error);
            }
        });

        // Connect buttons
        document.getElementById('connect-ton-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ platform: 'ton' }),
                });
                const data = await response.json();
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                }
            } catch (error) {
                console.error("Error connecting:", error);
            }
        });

        document.getElementById('connect-eth-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ platform: 'eth' }),
                });
                const data = await response.json();
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                }
            } catch (error) {
                console.error("Error connecting:", error);
            }
        });

        document.getElementById('connect-tron-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ platform: 'tron' }),
                });
                const data = await response.json();
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                }
            } catch (error) {
                console.error("Error connecting:", error);
            }
        });

        tg.ready();
    </script>
</body>
</html>
